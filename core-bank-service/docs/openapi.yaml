# 核心银行服务 - OpenAPI 3.0 规范
# 遵循: api-design-spec-v1.0, technical-standards-v1.0, naming-conventions, data-dictionary-v1.0

openapi: "3.0.3"
info:
  title: 核心银行服务 API
  version: 1.0.0
  description: |
    数字银行 POC - 核心银行服务引擎。提供账户管理、交易处理、客户信息等 REST API。
    路径：/api/v1/，资源 kebab-case 复数。日期 ISO 8601，金额与 data-dictionary 一致。

servers:
  - url: http://localhost:8080
    description: 本地开发

tags:
  - name: accounts
    description: 账户管理
  - name: customers
    description: 客户信息
  - name: transactions
    description: 交易处理

paths:
  # ---------- 账户 ----------
  /api/v1/accounts:
    post:
      summary: 开户
      description: 为客户创建新账户
      operationId: createAccount
      tags: [accounts]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreateAccountRequest" }
      responses:
        "201":
          description: 创建成功
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiResponse#/properties/data" }
              example: { accountId: 1, accountNumber: "6200123456789012", customerId: 1, balance: 0, currency: "CNY", accountType: "savings", status: "active" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalError" }
    get:
      summary: 查询账户列表
      operationId: listAccounts
      tags: [accounts]
      parameters:
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
        - name: customerId
          in: query
          schema: { type: integer, format: int64 }
          description: 按客户ID过滤
        - name: status
          in: query
          schema: { type: string, enum: [active, inactive, frozen, closed] }
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AccountListResponse" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "500": { $ref: "#/components/responses/InternalError" }

  /api/v1/accounts/{account-id}:
    get:
      summary: 查询账户详情
      operationId: getAccount
      tags: [accounts]
      parameters:
        - $ref: "#/components/parameters/AccountId"
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AccountResponse" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalError" }

  /api/v1/accounts/{account-id}/balance:
    get:
      summary: 余额查询
      operationId: getBalance
      tags: [accounts]
      parameters:
        - $ref: "#/components/parameters/AccountId"
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                required: [accountId, balance, currency]
                properties:
                  accountId: { type: integer, format: int64 }
                  balance: { type: number, format: double, description: "DECIMAL(19,2)" }
                  currency: { type: string, example: "CNY" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalError" }

  # ---------- 客户 ----------
  /api/v1/customers:
    post:
      summary: 客户注册
      operationId: createCustomer
      tags: [customers]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreateCustomerRequest" }
      responses:
        "201":
          description: 创建成功
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CustomerResponse" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "409": { description: "冲突，如身份证号已存在", $ref: "#/components/responses/Conflict" }
        "500": { $ref: "#/components/responses/InternalError" }

  /api/v1/customers/{customer-id}:
    get:
      summary: 客户查询
      operationId: getCustomer
      tags: [customers]
      parameters:
        - name: customer-id
          in: path
          required: true
          schema: { type: integer, format: int64 }
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CustomerResponse" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalError" }
    put:
      summary: 客户更新
      operationId: updateCustomer
      tags: [customers]
      parameters:
        - name: customer-id
          in: path
          required: true
          schema: { type: integer, format: int64 }
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/UpdateCustomerRequest" }
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CustomerResponse" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalError" }

  # ---------- 交易 ----------
  /api/v1/transactions:
    get:
      summary: 交易查询
      operationId: listTransactions
      tags: [transactions]
      parameters:
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
        - name: accountId
          in: query
          schema: { type: integer, format: int64 }
        - name: status
          in: query
          schema: { type: string, enum: [pending, processing, completed, failed, cancelled] }
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema: { $ref: "#/components/schemas/TransactionListResponse" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "500": { $ref: "#/components/responses/InternalError" }

  /api/v1/transactions/history:
    get:
      summary: 交易历史
      operationId: getTransactionHistory
      tags: [transactions]
      parameters:
        - name: accountId
          in: query
          required: true
          schema: { type: integer, format: int64 }
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
        - name: from
          in: query
          schema: { type: string, format: date-time }
        - name: to
          in: query
          schema: { type: string, format: date-time }
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema: { $ref: "#/components/schemas/TransactionListResponse" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "500": { $ref: "#/components/responses/InternalError" }

  /api/v1/transactions/debit:
    post:
      summary: 支付扣款（ADR-005）
      description: |
        供支付服务等调用。幂等：同一 refId 多次请求返回同一 transactionId，不重复扣款。
        Request: accountId, amount, refId, remark?；Response 201: transactionId, accountId, amount, status。
      operationId: debit
      tags: [transactions]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/DebitRequest" }
      responses:
        "201":
          description: 创建成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code: { type: integer, example: 201 }
                  message: { type: string, example: "Created" }
                  data:
                    type: object
                    properties:
                      transactionId: { type: string }
                      accountId: { type: integer, format: int64 }
                      amount: { type: number }
                      status: { type: string, example: "completed" }
                  timestamp: { type: string, format: date-time }
        "400": { $ref: "#/components/responses/BadRequest" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalError" }

  /api/v1/transactions/transfer:
    post:
      summary: 行内转账
      operationId: transfer
      tags: [transactions]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/TransferRequest" }
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  transactionId: { type: string }
                  fromAccountId: { type: integer, format: int64 }
                  toAccountId: { type: integer, format: int64 }
                  amount: { type: number }
                  status: { type: string, example: "completed" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "403": { description: "风控拦截等", $ref: "#/components/responses/Forbidden" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalError" }

components:
  parameters:
    Page:
      name: page
      in: query
      schema: { type: integer, default: 1, minimum: 1 }
    PageSize:
      name: pageSize
      in: query
      schema: { type: integer, default: 20, minimum: 1, maximum: 100 }
    AccountId:
      name: account-id
      in: path
      required: true
      schema: { type: integer, format: int64 }

  schemas:
    CreateAccountRequest:
      type: object
      required: [customerId, accountType]
      properties:
        customerId: { type: integer, format: int64 }
        accountType: { type: string, enum: [savings, current], default: savings }
        currency: { type: string, default: "CNY" }
    AccountResponse:
      type: object
      properties:
        accountId: { type: integer, format: int64 }
        accountNumber: { type: string }
        customerId: { type: integer, format: int64 }
        balance: { type: number, format: double }
        currency: { type: string }
        accountType: { type: string }
        status: { type: string, enum: [active, inactive, frozen, closed] }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    AccountListResponse:
      type: object
      properties:
        items: { type: array, items: { $ref: "#/components/schemas/AccountResponse" } }
        total: { type: integer }
        page: { type: integer }
        pageSize: { type: integer }

    CreateCustomerRequest:
      type: object
      required: [name]
      properties:
        name: { type: string, maxLength: 100 }
        idCard: { type: string, maxLength: 18 }
        phone: { type: string, maxLength: 20 }
        email: { type: string, maxLength: 128 }
        address: { type: string }
        status: { type: string, enum: [active, inactive, blocked], default: active }
    UpdateCustomerRequest:
      type: object
      properties:
        name: { type: string, maxLength: 100 }
        phone: { type: string, maxLength: 20 }
        email: { type: string, maxLength: 128 }
        address: { type: string }
        status: { type: string, enum: [active, inactive, blocked] }
    CustomerResponse:
      type: object
      properties:
        customerId: { type: integer, format: int64 }
        name: { type: string }
        idCard: { type: string }
        phone: { type: string }
        email: { type: string }
        address: { type: string }
        status: { type: string }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    DebitRequest:
      type: object
      required: [accountId, amount, refId]
      description: 支付扣款请求，ADR-005。refId 用于幂等。
      properties:
        accountId: { type: integer, format: int64 }
        amount: { type: number, format: double, minimum: 0.01 }
        refId: { type: string, description: "外部引用号如 paymentId，幂等键" }
        remark: { type: string }
    DebitResponse:
      type: object
      properties:
        transactionId: { type: string }
        accountId: { type: integer, format: int64 }
        amount: { type: number }
        status: { type: string, example: "completed" }
    TransferRequest:
      type: object
      required: [fromAccountId, toAccountId, amount]
      properties:
        fromAccountId: { type: integer, format: int64 }
        toAccountId: { type: integer, format: int64 }
        amount: { type: number, format: double, minimum: 0.01, description: "DECIMAL(19,2)" }
        remark: { type: string }
    TransactionResponse:
      type: object
      properties:
        transactionId: { type: string }
        accountId: { type: integer, format: int64 }
        counterAccountId: { type: integer, format: int64, nullable: true }
        amount: { type: number }
        transactionType: { type: string, enum: [deposit, withdrawal, transfer_in, transfer_out, payment] }
        status: { type: string, enum: [pending, processing, completed, failed, cancelled] }
        remark: { type: string }
        createdAt: { type: string, format: date-time }
    TransactionListResponse:
      type: object
      properties:
        items: { type: array, items: { $ref: "#/components/schemas/TransactionResponse" } }
        total: { type: integer }
        page: { type: integer }
        pageSize: { type: integer }

    ApiResponse:
      type: object
      properties:
        code: { type: integer, example: 200 }
        message: { type: string, example: "Success" }
        data: {}
        timestamp: { type: string, format: date-time }
    ErrorResponse:
      type: object
      properties:
        code: { type: integer }
        message: { type: string }
        errorCode: { type: string, description: "如 CBB001, CBV001" }
        errors: { type: array, items: { $ref: "#/components/schemas/FieldError" } }
        timestamp: { type: string, format: date-time }
    FieldError:
      type: object
      properties:
        field: { type: string }
        message: { type: string }

  responses:
    BadRequest:
      description: 请求参数错误或业务规则拒绝（如 CBB002 余额不足、CBV001 格式无效）
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
          example: { code: 400, message: "Bad Request", errorCode: "CBV001", errors: [{ field: "accountNumber", message: "Account number is required" }], timestamp: "2026-01-27T10:00:00Z" }
    NotFound:
      description: 资源不存在（CBB001 账户不存在、CBB006 客户不存在）
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
          example: { code: 404, message: "Not Found", errorCode: "CBB001", timestamp: "2026-01-27T10:00:00Z" }
    Forbidden:
      description: 无权限或风控拦截（RKB001）
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
    Conflict:
      description: 冲突（如重复身份证号）
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
    InternalError:
      description: 服务端错误（CBS001 等）
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT Token，Authorization: Bearer &lt;token&gt;

security: []
