# 风险传导分析文档

> **版本**: v1.0
> **创建日期**: 2026-01-27
> **关联文档**: [Agent影响分析](agent-impact-analysis.md)

---

## 一、风险分级标准

### 1.1 严重程度定义

| 级别 | 名称 | 定义 | 影响范围 | 响应时间 |
|------|------|------|----------|----------|
| **P0** | 致命 | 系统完全不可用 | 全部用户 | < 5分钟 |
| **P1** | 严重 | 核心功能不可用 | 大部分用户 | < 15分钟 |
| **P2** | 高 | 部分功能降级 | 部分用户 | < 30分钟 |
| **P3** | 中 | 非核心功能受影响 | 少量用户 | < 2小时 |
| **P4** | 低 | 开发/测试环境问题 | 内部人员 | < 8小时 |

### 1.2 恢复指标定义

| 指标 | 定义 | P0目标 | P1目标 | P2目标 |
|------|------|--------|--------|--------|
| **RTO** | 恢复时间目标 | < 5分钟 | < 15分钟 | < 30分钟 |
| **RPO** | 恢复点目标 | 0 | < 1分钟 | < 5分钟 |
| **MTTR** | 平均修复时间 | < 10分钟 | < 30分钟 | < 1小时 |

---

## 二、故障场景分析

### 2.1 P0级故障场景

#### 场景1: Kong网关故障 (A5)

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Kong网关故障传导路径                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│                          ┌──────────┐                               │
│                          │   A5     │                               │
│                          │Kong故障  │                               │
│                          └────┬─────┘                               │
│                               │                                      │
│           ┌───────────────────┼───────────────────┐                 │
│           │                   │                   │                 │
│           ▼                   ▼                   ▼                 │
│     ┌──────────┐       ┌──────────┐       ┌──────────┐            │
│     │   A1     │       │   A2     │       │   A3     │            │
│     │API不可达 │       │API不可达 │       │API不可达 │            │
│     └────┬─────┘       └────┬─────┘       └────┬─────┘            │
│          │                  │                  │                   │
│          └──────────────────┼──────────────────┘                   │
│                             │                                       │
│                             ▼                                       │
│                       ┌──────────┐                                 │
│                       │   A4     │                                 │
│                       │前端全部报错│                                 │
│                       └──────────┘                                 │
│                                                                      │
│  影响: 全系统不可用，所有用户无法访问                                 │
│  RTO: < 5分钟                                                       │
│  RPO: 0 (无数据丢失)                                                │
└─────────────────────────────────────────────────────────────────────┘
```

**故障信息:**
| 属性 | 值 |
|------|------|
| 故障Agent | A5 应用基础设施 |
| 故障组件 | Kong API网关 |
| 直接影响 | A1, A2, A3, A4 |
| 间接影响 | 全系统 |
| 严重程度 | P0 - 致命 |
| 影响范围 | 100%用户 |

**缓解措施:**
| 措施 | 描述 | 负责Agent | 实施状态 |
|------|------|-----------|----------|
| 多实例部署 | Kong部署≥3个副本 | A5, A8 | 必须 |
| 健康检查 | 配置liveness/readiness探针 | A5, A8 | 必须 |
| 自动故障转移 | K8s自动重启失败Pod | A8 | 必须 |
| 备用网关 | 部署备用Nginx作为降级方案 | A5 | 建议 |
| 限流保护 | 配置请求限流防止过载 | A5 | 必须 |

**恢复步骤:**
1. 监控告警触发（< 30秒）
2. 自动健康检查失败，K8s重启Pod（< 1分钟）
3. 新Pod启动并通过健康检查（< 2分钟）
4. 流量自动切换到健康实例（< 30秒）
5. 确认服务恢复，关闭告警（< 1分钟）

---

#### 场景2: PostgreSQL数据库故障 (A9)

```
┌─────────────────────────────────────────────────────────────────────┐
│                   PostgreSQL故障传导路径                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│                          ┌──────────┐                               │
│                          │   A9     │                               │
│                          │ PG故障   │                               │
│                          └────┬─────┘                               │
│                               │                                      │
│                               ▼                                      │
│                        ┌──────────┐                                 │
│                        │   A1     │                                 │
│                        │核心银行故障│                                 │
│                        └────┬─────┘                                 │
│                             │                                        │
│              ┌──────────────┼──────────────┐                        │
│              │              │              │                        │
│              ▼              ▼              ▼                        │
│       ┌──────────┐   ┌──────────┐   ┌──────────┐                   │
│       │   A2     │   │   A3     │   │   A4     │                   │
│       │ 支付失败  │   │ 风控降级  │   │ 前端报错  │                   │
│       │(账户查询失败)│ │(画像查询失败)│ │          │                   │
│       └──────────┘   └──────────┘   └──────────┘                   │
│                                                                      │
│  传导链: A9 → A1 → A2/A3/A4                                         │
│  影响: 核心业务不可用，账户/交易功能全部失效                          │
│  RTO: < 5分钟                                                       │
│  RPO: < 1分钟 (依赖复制延迟)                                        │
└─────────────────────────────────────────────────────────────────────┘
```

**故障信息:**
| 属性 | 值 |
|------|------|
| 故障Agent | A9 数据处理分析师 |
| 故障组件 | PostgreSQL 15 |
| 直接影响 | A1 |
| 级联影响 | A2, A3, A4 |
| 严重程度 | P0 - 严重 |
| 影响范围 | 账户/交易功能100% |

**缓解措施:**
| 措施 | 描述 | 负责Agent | 实施状态 |
|------|------|-----------|----------|
| 主从复制 | 配置同步复制从库 | A9 | 必须 |
| 自动故障转移 | 使用Patroni/pg_auto_failover | A9, A8 | 必须 |
| 定期备份 | 每日全量+每小时增量备份 | A9, A8 | 必须 |
| 连接池 | 使用PgBouncer连接池 | A9 | 必须 |
| 读写分离 | 读请求路由到从库 | A1, A9 | 建议 |

**恢复步骤:**
1. 监控检测到主库不可用（< 30秒）
2. Patroni触发自动故障转移（< 1分钟）
3. 从库提升为主库（< 30秒）
4. 应用重新连接新主库（< 1分钟）
5. 确认数据一致性（< 2分钟）
6. 启动新从库同步（后台进行）

---

### 2.2 P1级故障场景

#### 场景3: 核心银行服务故障 (A1)

```
┌─────────────────────────────────────────────────────────────────────┐
│                   核心银行服务故障传导路径                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│                          ┌──────────┐                               │
│                          │   A1     │                               │
│                          │ 服务故障  │                               │
│                          └────┬─────┘                               │
│                               │                                      │
│              ┌────────────────┼────────────────┐                    │
│              │                │                │                    │
│              ▼                ▼                ▼                    │
│       ┌──────────┐     ┌──────────┐     ┌──────────┐              │
│       │   A2     │     │   A3     │     │   A4     │              │
│       │支付调用失败│     │画像获取失败│     │账户功能不可用│              │
│       └────┬─────┘     └──────────┘     └──────────┘              │
│            │                                                        │
│            ▼                                                        │
│     ┌────────────┐                                                 │
│     │ 支付降级    │                                                 │
│     │(仅查询可用) │                                                 │
│     └────────────┘                                                 │
│                                                                      │
│  影响: 账户管理、转账交易不可用                                       │
│  降级: A2可查询支付历史，A3可基于缓存工作                             │
│  RTO: < 15分钟                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**缓解措施:**
| 措施 | 描述 | 负责Agent |
|------|------|-----------|
| 多实例部署 | 部署≥3个副本 | A1, A8 |
| 熔断器 | 配置Resilience4j熔断 | A1 |
| 降级策略 | A2/A3降级到缓存或只读模式 | A2, A3 |
| 限流保护 | API限流防止过载 | A1, A5 |

---

#### 场景4: 支付服务故障 (A2)

```
┌─────────────────────────────────────────────────────────────────────┐
│                    支付服务故障传导路径                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│                          ┌──────────┐                               │
│                          │   A2     │                               │
│                          │ 服务故障  │                               │
│                          └────┬─────┘                               │
│                               │                                      │
│              ┌────────────────┼────────────────┐                    │
│              │                │                │                    │
│              ▼                ▼                ▼                    │
│       ┌──────────┐     ┌──────────┐     ┌──────────┐              │
│       │   A1     │     │   A3     │     │   A4     │              │
│       │(Saga补偿) │     │(支付检查失败)│   │支付功能不可用│              │
│       └──────────┘     └──────────┘     └──────────┘              │
│                                                                      │
│  影响: 支付、充值、提现功能不可用                                     │
│  降级: 账户查询正常，风控可基于历史数据                               │
│  RTO: < 15分钟                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**缓解措施:**
| 措施 | 描述 | 负责Agent |
|------|------|-----------|
| 多实例部署 | 部署≥3个副本 | A2, A8 |
| 重试机制 | 异步支付重试队列 | A2 |
| 幂等性 | 支付请求幂等处理 | A2 |
| Saga补偿 | 失败时触发补偿事务 | A1, A2 |

---

#### 场景5: 风控服务故障 (A3)

```
┌─────────────────────────────────────────────────────────────────────┐
│                    风控服务故障传导路径                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│                          ┌──────────┐                               │
│                          │   A3     │                               │
│                          │ 服务故障  │                               │
│                          └────┬─────┘                               │
│                               │                                      │
│              ┌────────────────┴────────────────┐                    │
│              │                                 │                    │
│              ▼                                 ▼                    │
│       ┌──────────┐                      ┌──────────┐              │
│       │   A1     │                      │   A2     │              │
│       │风控检查失败│                      │风控检查失败│              │
│       └────┬─────┘                      └────┬─────┘              │
│            │                                  │                    │
│            ▼                                  ▼                    │
│   ┌──────────────────┐              ┌──────────────────┐         │
│   │ 降级: 放行小额    │              │ 降级: 放行小额    │         │
│   │ 或拒绝大额交易    │              │ 或拒绝大额支付    │         │
│   └──────────────────┘              └──────────────────┘         │
│                                                                      │
│  影响: 风控检查不可用                                                │
│  降级策略:                                                          │
│    - 小额交易(≤1000): 放行                                          │
│    - 大额交易(>1000): 拒绝或人工审核                                 │
│  RTO: < 15分钟                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**缓解措施:**
| 措施 | 描述 | 负责Agent |
|------|------|-----------|
| 多实例部署 | 部署≥3个副本 | A3, A8 |
| 降级策略 | 小额放行、大额拒绝 | A1, A2, A3 |
| 规则缓存 | 本地缓存风控规则 | A1, A2 |
| 超时控制 | 风控检查超时5秒后降级 | A1, A2 |

---

### 2.3 P2级故障场景

#### 场景6: Redis缓存故障 (A9)

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Redis缓存故障传导路径                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│                          ┌──────────┐                               │
│                          │   A9     │                               │
│                          │Redis故障 │                               │
│                          └────┬─────┘                               │
│                               │                                      │
│           ┌───────────────────┼───────────────────┐                 │
│           │                   │                   │                 │
│           ▼                   ▼                   ▼                 │
│     ┌──────────┐       ┌──────────┐       ┌──────────┐            │
│     │   A1     │       │   A2     │       │   A3     │            │
│     │缓存失效  │       │缓存失效  │       │缓存失效  │            │
│     │直接查DB  │       │直接查DB  │       │直接查ES  │            │
│     └────┬─────┘       └────┬─────┘       └────┬─────┘            │
│          │                  │                  │                   │
│          └──────────────────┼──────────────────┘                   │
│                             │                                       │
│                             ▼                                       │
│                    ┌──────────────┐                                │
│                    │ 性能下降     │                                │
│                    │ 响应时间增加  │                                │
│                    │ 数据库负载上升│                                │
│                    └──────────────┘                                │
│                                                                      │
│  影响: 系统性能下降，但功能正常                                       │
│  降级: 所有服务降级到直接查询数据库                                   │
│  RTO: < 30分钟                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**缓解措施:**
| 措施 | 描述 | 负责Agent |
|------|------|-----------|
| Redis集群 | 部署Redis Cluster或Sentinel | A9, A8 |
| 本地缓存 | 应用层本地缓存兜底 | A1, A2, A3 |
| 连接池 | 配置合理的连接池大小 | A1, A2, A3 |
| 数据库扩容 | 准备数据库扩容方案 | A9 |

---

### 2.4 P3级故障场景

#### 场景7: CI/CD流水线故障 (A8)

```
┌─────────────────────────────────────────────────────────────────────┐
│                    CI/CD故障传导路径                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│                          ┌──────────┐                               │
│                          │   A8     │                               │
│                          │CI/CD故障 │                               │
│                          └────┬─────┘                               │
│                               │                                      │
│           ┌───────────────────┼───────────────────┐                 │
│           │                   │                   │                 │
│           ▼                   ▼                   ▼                 │
│     ┌──────────┐       ┌──────────┐       ┌──────────┐            │
│     │   A1     │       │   A2     │       │   A3     │            │
│     │ 无法部署 │       │ 无法部署 │       │ 无法部署 │            │
│     └──────────┘       └──────────┘       └──────────┘            │
│                                                                      │
│  影响: 新版本无法发布，但现有系统正常运行                             │
│  降级: 手动部署作为备选方案                                          │
│  RTO: < 2小时                                                       │
└─────────────────────────────────────────────────────────────────────┘
```

---

#### 场景8: 安全扫描故障 (A7)

```
┌─────────────────────────────────────────────────────────────────────┐
│                    安全扫描故障传导路径                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│                          ┌──────────┐                               │
│                          │   A7     │                               │
│                          │扫描故障  │                               │
│                          └────┬─────┘                               │
│                               │                                      │
│                               ▼                                      │
│                        ┌──────────┐                                 │
│                        │   A8     │                                 │
│                        │安全阶段失败│                                 │
│                        └────┬─────┘                                 │
│                             │                                        │
│                             ▼                                        │
│                    ┌──────────────┐                                 │
│                    │ 发布被阻断   │                                 │
│                    │ (可手动跳过) │                                 │
│                    └──────────────┘                                 │
│                                                                      │
│  影响: 安全扫描阶段失败，发布流程阻断                                 │
│  降级: 紧急情况可跳过扫描，但需记录技术债务                           │
│  RTO: < 2小时                                                       │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 三、故障恢复流程

### 3.1 P0故障恢复流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                       P0故障恢复流程                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  T+0s      T+30s     T+1m      T+2m      T+3m      T+5m            │
│   │         │         │         │         │         │              │
│   ▼         ▼         ▼         ▼         ▼         ▼              │
│ ┌───┐    ┌───┐    ┌───────┐  ┌───────┐  ┌───────┐  ┌───────┐     │
│ │告警│───▶│确认│───▶│自动恢复│─▶│手动介入│─▶│恢复验证│─▶│关闭告警│     │
│ │触发│    │故障│    │启动    │  │(如需要)│  │        │  │        │     │
│ └───┘    └───┘    └───────┘  └───────┘  └───────┘  └───────┘     │
│                                                                      │
│ 参与角色:                                                           │
│ - T+0s: 监控系统自动检测                                            │
│ - T+30s: 值班人员确认告警                                           │
│ - T+1m: K8s/Patroni自动恢复                                         │
│ - T+2m: 如自动恢复失败，值班人员手动介入                             │
│ - T+3m: 验证服务恢复                                                │
│ - T+5m: 关闭告警，记录事件                                          │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 故障升级路径

```
┌─────────────────────────────────────────────────────────────────────┐
│                        故障升级路径                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  故障发生                                                            │
│      │                                                               │
│      ▼                                                               │
│  ┌───────────────┐                                                  │
│  │ Level 1: 自动 │ ─── 自动恢复成功 ───▶ 记录事件，关闭             │
│  │ 恢复机制     │                                                   │
│  └───────┬───────┘                                                  │
│          │ 失败(2分钟内)                                            │
│          ▼                                                          │
│  ┌───────────────┐                                                  │
│  │ Level 2: 值班 │ ─── 手动恢复成功 ───▶ 记录事件，复盘             │
│  │ 工程师介入    │                                                   │
│  └───────┬───────┘                                                  │
│          │ 失败(5分钟内)                                            │
│          ▼                                                          │
│  ┌───────────────┐                                                  │
│  │ Level 3: Agent│ ─── 专家恢复成功 ───▶ 记录事件，复盘             │
│  │ Owner介入     │                                                   │
│  └───────┬───────┘                                                  │
│          │ 失败(15分钟内)                                           │
│          ▼                                                          │
│  ┌───────────────┐                                                  │
│  │ Level 4: A0   │ ─── 协调多Agent恢复 ─▶ 事后详细复盘             │
│  │ 架构师介入    │                                                   │
│  └───────────────┘                                                  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 四、降级策略

### 4.1 服务降级矩阵

| 故障组件 | 降级策略 | 降级后功能 | 数据一致性 |
|----------|----------|------------|------------|
| Kong网关 | 备用Nginx直连 | 有限路由 | 保证 |
| PostgreSQL | 只读从库 | 只读操作 | 延迟< 1s |
| MongoDB | 本地缓存 | 历史数据 | 可能过期 |
| Redis | 直接查DB | 全部功能 | 保证 |
| A1服务 | 缓存数据 | 查询功能 | 可能过期 |
| A2服务 | 异步重试 | 延迟处理 | 最终一致 |
| A3服务 | 小额放行 | 有限风控 | 保证 |

### 4.2 降级触发条件

| 条件 | 阈值 | 降级动作 |
|------|------|----------|
| 错误率 | > 50% (30秒内) | 熔断开启 |
| 响应时间 | P95 > 5s | 限流启动 |
| 连接数 | > 80%容量 | 新请求排队 |
| CPU使用率 | > 90% | 限流+告警 |
| 内存使用率 | > 85% | GC优化+告警 |

### 4.3 熔断配置

```yaml
# A1核心银行服务熔断配置
resilience4j:
  circuitbreaker:
    instances:
      riskService:
        registerHealthIndicator: true
        slidingWindowSize: 10
        permittedNumberOfCallsInHalfOpenState: 3
        slidingWindowType: COUNT_BASED
        minimumNumberOfCalls: 5
        waitDurationInOpenState: 30s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
```

---

## 五、监控告警配置

### 5.1 告警规则

```yaml
# Prometheus告警规则
groups:
  - name: critical_alerts
    rules:
      # Kong网关告警
      - alert: KongGatewayDown
        expr: up{job="kong"} == 0
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "Kong网关不可用"

      # 数据库连接告警
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL数据库不可用"

      # 服务错误率告警
      - alert: HighErrorRate
        expr: |
          sum(rate(http_requests_total{status=~"5.."}[5m])) by (service)
          / sum(rate(http_requests_total[5m])) by (service) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "服务 {{ $labels.service }} 错误率过高"

      # 响应时间告警
      - alert: HighLatency
        expr: |
          histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "服务 {{ $labels.service }} P95延迟过高"
```

### 5.2 告警通知渠道

| 级别 | 通知渠道 | 通知对象 | 响应要求 |
|------|----------|----------|----------|
| P0 | 电话+短信+企微 | 值班+Owner+A0 | 立即响应 |
| P1 | 短信+企微 | 值班+Owner | 5分钟内响应 |
| P2 | 企微 | Owner | 15分钟内响应 |
| P3 | 邮件 | 相关人员 | 工作时间响应 |

---

## 六、复盘模板

### 6.1 事件复盘模板

```markdown
# 故障复盘报告

## 基本信息
- **事件ID**: INC-2026-XXX
- **发生时间**: YYYY-MM-DD HH:MM:SS
- **恢复时间**: YYYY-MM-DD HH:MM:SS
- **持续时长**: XX分钟
- **严重级别**: P0/P1/P2/P3
- **影响范围**: [描述影响的用户/功能]

## 事件经过
### 时间线
| 时间 | 事件 | 操作人 |
|------|------|--------|
| HH:MM | 告警触发 | 系统 |
| HH:MM | 确认故障 | XXX |
| HH:MM | 执行恢复 | XXX |
| HH:MM | 恢复完成 | XXX |

## 根因分析
### 直接原因
[描述直接导致故障的原因]

### 根本原因
[描述根本原因，使用5Why分析]

## 影响评估
- **受影响用户数**: XXX
- **受影响交易数**: XXX
- **业务损失**: [描述或N/A]

## 改进措施
| 措施 | 负责人 | 截止日期 | 状态 |
|------|--------|----------|------|
| [措施1] | XXX | YYYY-MM-DD | 待办 |
| [措施2] | XXX | YYYY-MM-DD | 待办 |

## 经验教训
[总结可复用的经验]
```

---

**文档版本**: v1.0
**创建日期**: 2026-01-27
**维护者**: Digital Bank POC Team
