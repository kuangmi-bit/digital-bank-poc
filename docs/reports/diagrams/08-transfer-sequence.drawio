<mxfile host="app.diagrams.net" modified="2026-02-01T00:00:00.000Z" agent="Claude" version="21.0.0" etag="transfer-sequence" type="device">
  <diagram id="transfer-seq" name="行内转账流程时序图">
    <mxGraphModel dx="1600" dy="1200" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="1200" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- 背景框 -->
        <mxCell id="bg-frame" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FAFAFA;strokeColor=#E0E0E0;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="30" width="1520" height="1140" as="geometry" />
        </mxCell>

        <!-- 标题 -->
        <mxCell id="title" value="行内转账流程时序图" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=24;fontStyle=1;fontColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="600" y="50" width="400" height="40" as="geometry" />
        </mxCell>

        <!-- 参与者 -->
        <mxCell id="frontend-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#1976D2;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="140" y="110" width="140" height="50" as="geometry" />
        </mxCell>
        <mxCell id="frontend-label" value="Frontend" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1;fontColor=#1976D2;" vertex="1" parent="1">
          <mxGeometry x="160" y="120" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="frontend-line" style="endArrow=none;html=1;strokeWidth=2;strokeColor=#1976D2;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="210" y="160" as="sourcePoint" />
            <mxPoint x="210" y="950" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="corebank-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="440" y="110" width="140" height="50" as="geometry" />
        </mxCell>
        <mxCell id="corebank-label" value="Core Bank" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1;fontColor=#388E3C;" vertex="1" parent="1">
          <mxGeometry x="460" y="120" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="corebank-line" style="endArrow=none;html=1;strokeWidth=2;strokeColor=#388E3C;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="510" y="160" as="sourcePoint" />
            <mxPoint x="510" y="950" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="risk-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#C62828;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="740" y="110" width="140" height="50" as="geometry" />
        </mxCell>
        <mxCell id="risk-label" value="Risk Service" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1;fontColor=#C62828;" vertex="1" parent="1">
          <mxGeometry x="760" y="120" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="risk-line" style="endArrow=none;html=1;strokeWidth=2;strokeColor=#C62828;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="810" y="160" as="sourcePoint" />
            <mxPoint x="810" y="950" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="db-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1976D2;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="1040" y="110" width="140" height="50" as="geometry" />
        </mxCell>
        <mxCell id="db-label" value="PostgreSQL" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1;fontColor=#1976D2;" vertex="1" parent="1">
          <mxGeometry x="1060" y="120" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="db-line" style="endArrow=none;html=1;strokeWidth=2;strokeColor=#1976D2;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1110" y="160" as="sourcePoint" />
            <mxPoint x="1110" y="950" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- 消息 1: POST /transfer -->
        <mxCell id="msg1" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#333333;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="210" y="200" as="sourcePoint" />
            <mxPoint x="510" y="200" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg1-label" value="POST /api/v1/transfers" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="280" y="180" width="150" height="20" as="geometry" />
        </mxCell>

        <!-- 激活框 Core Bank -->
        <mxCell id="corebank-active" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;" vertex="1" parent="1">
          <mxGeometry x="500" y="200" width="20" height="700" as="geometry" />
        </mxCell>

        <!-- 消息 2: POST /risk/check -->
        <mxCell id="msg2" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#C62828;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="520" y="250" as="sourcePoint" />
            <mxPoint x="810" y="250" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg2-label" value="POST /api/v1/risk/check" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontColor=#C62828;" vertex="1" parent="1">
          <mxGeometry x="600" y="230" width="150" height="20" as="geometry" />
        </mxCell>

        <!-- 激活框 Risk -->
        <mxCell id="risk-active" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#C62828;" vertex="1" parent="1">
          <mxGeometry x="800" y="250" width="20" height="120" as="geometry" />
        </mxCell>

        <!-- 规则引擎检查 -->
        <mxCell id="rule-check" value="规则引擎检查&#xa;• 限额规则&#xa;• 频率规则&#xa;• 黑名单规则" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF3E0;strokeColor=#F57C00;align=left;fontSize=10;spacingLeft=5;" vertex="1" parent="1">
          <mxGeometry x="840" y="270" width="120" height="70" as="geometry" />
        </mxCell>

        <!-- 消息 3: 200 OK (passed) -->
        <mxCell id="msg3" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#4CAF50;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="800" y="370" as="sourcePoint" />
            <mxPoint x="520" y="370" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg3-label" value="200 OK (passed)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontColor=#4CAF50;" vertex="1" parent="1">
          <mxGeometry x="600" y="350" width="120" height="20" as="geometry" />
        </mxCell>

        <!-- 消息 4: BEGIN TRANSACTION -->
        <mxCell id="msg4" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#1976D2;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="520" y="420" as="sourcePoint" />
            <mxPoint x="1110" y="420" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg4-label" value="BEGIN TRANSACTION" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1;fontColor=#1976D2;" vertex="1" parent="1">
          <mxGeometry x="720" y="400" width="150" height="20" as="geometry" />
        </mxCell>

        <!-- 激活框 DB -->
        <mxCell id="db-active" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1976D2;" vertex="1" parent="1">
          <mxGeometry x="1100" y="420" width="20" height="400" as="geometry" />
        </mxCell>

        <!-- 消息 5: SELECT FOR UPDATE -->
        <mxCell id="msg5" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#1976D2;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="520" y="480" as="sourcePoint" />
            <mxPoint x="1100" y="480" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg5-label" value="SELECT ... FOR UPDATE (按ID顺序)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontColor=#1976D2;" vertex="1" parent="1">
          <mxGeometry x="680" y="460" width="220" height="20" as="geometry" />
        </mxCell>

        <!-- 悲观锁说明 -->
        <mxCell id="lock-note" value="悲观锁加锁&#xa;避免死锁" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8EAF6;strokeColor=#3F51B5;align=center;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1140" y="470" width="80" height="40" as="geometry" />
        </mxCell>

        <!-- 消息 6: UPDATE from_account -->
        <mxCell id="msg6" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#1976D2;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="520" y="550" as="sourcePoint" />
            <mxPoint x="1100" y="550" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg6-label" value="UPDATE from_account (扣款)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontColor=#1976D2;" vertex="1" parent="1">
          <mxGeometry x="700" y="530" width="200" height="20" as="geometry" />
        </mxCell>

        <!-- 消息 7: UPDATE to_account -->
        <mxCell id="msg7" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#1976D2;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="520" y="610" as="sourcePoint" />
            <mxPoint x="1100" y="610" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg7-label" value="UPDATE to_account (入账)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontColor=#1976D2;" vertex="1" parent="1">
          <mxGeometry x="700" y="590" width="200" height="20" as="geometry" />
        </mxCell>

        <!-- 消息 8: INSERT transactions -->
        <mxCell id="msg8" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#1976D2;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="520" y="670" as="sourcePoint" />
            <mxPoint x="1100" y="670" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg8-label" value="INSERT transactions (双向记录)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontColor=#1976D2;" vertex="1" parent="1">
          <mxGeometry x="700" y="650" width="200" height="20" as="geometry" />
        </mxCell>

        <!-- 消息 9: INSERT outbox_events -->
        <mxCell id="msg9" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#F57C00;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="520" y="730" as="sourcePoint" />
            <mxPoint x="1100" y="730" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg9-label" value="INSERT outbox_events (Outbox Pattern)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontColor=#F57C00;" vertex="1" parent="1">
          <mxGeometry x="680" y="710" width="240" height="20" as="geometry" />
        </mxCell>

        <!-- 消息 10: COMMIT -->
        <mxCell id="msg10" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#4CAF50;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="520" y="790" as="sourcePoint" />
            <mxPoint x="1100" y="790" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg10-label" value="COMMIT" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1;fontColor=#4CAF50;" vertex="1" parent="1">
          <mxGeometry x="750" y="770" width="100" height="20" as="geometry" />
        </mxCell>

        <!-- 消息 11: 200 OK -->
        <mxCell id="msg11" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#4CAF50;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="500" y="860" as="sourcePoint" />
            <mxPoint x="210" y="860" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg11-label" value="200 OK {transactionId}" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontColor=#4CAF50;" vertex="1" parent="1">
          <mxGeometry x="280" y="840" width="150" height="20" as="geometry" />
        </mxCell>

        <!-- 关键设计要点 -->
        <mxCell id="notes-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#4CAF50;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="80" y="970" width="1440" height="90" as="geometry" />
        </mxCell>
        <mxCell id="notes-title" value="关键设计要点" style="text;html=1;strokeColor=none;fillColor=#4CAF50;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=12;fontStyle=1;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="700" y="980" width="200" height="25" as="geometry" />
        </mxCell>
        <mxCell id="note1" value="1️⃣ 风控前置" style="text;html=1;strokeColor=none;fillColor=#FFFFFF;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=11;fontStyle=1;fontColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="120" y="1015" width="90" height="25" as="geometry" />
        </mxCell>
        <mxCell id="note1-desc" value="转账前先调用风控服务检查" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="220" y="1015" width="180" height="25" as="geometry" />
        </mxCell>
        <mxCell id="note2" value="2️⃣ 悲观锁" style="text;html=1;strokeColor=none;fillColor=#FFFFFF;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=11;fontStyle=1;fontColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="420" y="1015" width="90" height="25" as="geometry" />
        </mxCell>
        <mxCell id="note2-desc" value="按账户ID顺序加锁，避免死锁" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="520" y="1015" width="180" height="25" as="geometry" />
        </mxCell>
        <mxCell id="note3" value="3️⃣ 原子事务" style="text;html=1;strokeColor=none;fillColor=#FFFFFF;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=11;fontStyle=1;fontColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="720" y="1015" width="90" height="25" as="geometry" />
        </mxCell>
        <mxCell id="note3-desc" value="扣款、入账、记录在同一事务中完成" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="820" y="1015" width="200" height="25" as="geometry" />
        </mxCell>
        <mxCell id="note4" value="4️⃣ Outbox模式" style="text;html=1;strokeColor=none;fillColor=#FFFFFF;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=11;fontStyle=1;fontColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="1040" y="1015" width="100" height="25" as="geometry" />
        </mxCell>
        <mxCell id="note4-desc" value="事件与业务数据在同一事务中写入" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1150" y="1015" width="200" height="25" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
