# ADR-007: 性能优化策略

## 状态

已接受

## 上下文

随着 POC 阶段 1-2 核心服务（核心银行、支付、风控、前端）功能实现完毕，需要定义性能优化策略以确保系统在生产环境中满足 technical-standards-v1.0 定义的性能指标：

- API 响应时间 P95 < 500ms
- 数据库查询 P95 < 100ms
- 系统吞吐量 > 1000 TPS（核心交易）
- 可用性 > 99.9%

本 ADR 基于 Day 7 阶段验收的代码实现，制定性能优化策略与实施路径。

## 决策

### 1. 数据库性能优化

#### 1.1 PostgreSQL（核心银行）

| 优化项 | 策略 | 实施位置 |
|--------|------|----------|
| **索引优化** | 高频查询字段建立 B-tree 索引 | `bank_accounts.customer_id`, `transactions.account_id`, `transactions.created_at` |
| **行级锁顺序** | 按 account_id 升序加锁防死锁 | `TransactionService.transfer()` 已实现 |
| **连接池** | HikariCP 默认配置，最大连接数 20 | `application.yml` 可调整 |
| **查询优化** | 分页查询使用 Keyset Pagination | 大数据量场景可优化 |

#### 1.2 MongoDB（支付服务）

| 优化项 | 策略 | 实施位置 |
|--------|------|----------|
| **复合索引** | `(userId, status, createdAt)` 覆盖常用查询 | `init-mongodb-collections.js` 已定义 |
| **单字段索引** | `paymentId`(unique), `orderId`, `status` | 已实现 |
| **读写分离** | 生产环境可配置 Secondary 读 | 连接串参数 `readPreference` |

#### 1.3 Elasticsearch（风控服务）

| 优化项 | 策略 | 实施位置 |
|--------|------|----------|
| **单次聚合** | 合并 count_1h/24h/daily_accumulated 为单次查询 | `get_risk_context_aggregates()` 已实现 |
| **索引分片** | risk_events 按日期滚动，1 分片 0 副本（POC） | 生产需调整 |
| **查询缓存** | 规则引擎结果本地缓存（线程安全） | `RuleEngine` 已实现 |

### 2. 应用层性能优化

#### 2.1 核心银行服务（Java/Spring Boot）

| 优化项 | 策略 | 状态 |
|--------|------|------|
| **幂等扣款** | `refId` 去重，避免重复扣款 | ✅ 已实现 |
| **接口抽象** | RiskClient/PaymentClient 为 interface | ✅ 已实现（Day 6） |
| **事务边界** | 最小化事务范围，风控调用在事务外 | ✅ 已实现 |
| **Outbox 模式** | 同事务写 outbox_events，异步投递 | ✅ 已实现 |

#### 2.2 支付服务（Node.js/Express）

| 优化项 | 策略 | 状态 |
|--------|------|------|
| **并发锁** | `findOneAndUpdate` 原子操作 | ✅ 已实现 |
| **指数退避** | 失败重试 3 次，避免雪崩 | ✅ 已实现 |
| **异步队列** | Bull + Redis 处理回调后任务 | ✅ 已实现 |
| **优雅降级** | 无 Redis 时 no-op | ✅ 已实现 |

#### 2.3 风控服务（Python/FastAPI）

| 优化项 | 策略 | 状态 |
|--------|------|------|
| **规则热更新** | YAML 文件变更自动重载 | ✅ 已实现 |
| **LRU 缓存** | RiskService 单例缓存 | ✅ 已实现 |
| **内存监控** | 环形缓冲区记录决策，ES 不可用时可用 | ✅ 已实现 |
| **异步 IO** | async/await 全链路异步 | ✅ 已实现 |

#### 2.4 前端（React/Vite）

| 优化项 | 策略 | 状态 |
|--------|------|------|
| **代码分割** | React.lazy + Suspense 懒加载 | ✅ 已实现 |
| **骨架屏** | 加载状态友好展示 | ✅ 已实现 |
| **请求取消** | useEffect cleanup 防止内存泄漏 | ✅ 已实现 |
| **Tree Shaking** | Vite 生产构建自动优化 | ✅ 已配置 |

### 3. 基础设施性能优化

#### 3.1 Kong API Gateway

| 优化项 | 配置 | 说明 |
|--------|------|------|
| **全局限流** | 1000/min, 10000/h | 防止 DDoS |
| **服务限流** | accounts 100/min, payments 50/min | 差异化保护 |
| **超时配置** | connect 5s, read/write 60s | 防止长连接堆积 |
| **重试次数** | 3 次 | 失败自动重试 |

#### 3.2 缓存策略

| 层级 | 策略 | 实施 |
|------|------|------|
| **规则缓存** | 风控规则本地缓存，文件变更时刷新 | RuleEngine |
| **会话缓存** | JWT Token 客户端存储 | AuthContext |
| **静态资源** | Vite 构建 hash 文件名，长期缓存 | nginx 配置 |

### 4. 性能测试策略

#### 4.1 测试工具

- **API 测试**: JMeter（已配置 2 个脚本）
- **前端测试**: Lighthouse
- **数据库测试**: pgbench / mongobench

#### 4.2 测试场景

| 场景 | 目标 | 验证方式 |
|------|------|----------|
| 单用户转账 | P95 < 500ms | JMeter 单线程 |
| 并发转账 | 100 TPS，无死锁 | JMeter 100 线程 |
| 风控检查 | P95 < 200ms | JMeter + ES 监控 |
| 页面加载 | FCP < 1.5s | Lighthouse |

### 5. 监控与告警

| 指标 | 阈值 | 告警级别 |
|------|------|----------|
| API P95 响应时间 | > 500ms | WARNING |
| API P99 响应时间 | > 1000ms | CRITICAL |
| 数据库连接池使用率 | > 80% | WARNING |
| 队列堆积 | > 1000 jobs | WARNING |
| 错误率 | > 1% | CRITICAL |

## 后果

### 正面影响

1. 各服务已在开发阶段嵌入性能优化实践（幂等、缓存、异步、索引）
2. 性能测试策略明确，可在 Day 8+ 执行完整性能验证
3. 监控告警阈值定义，便于生产运维

### 负面影响

1. 部分优化需生产环境验证（如 ES 分片策略、连接池调优）
2. 缓存引入数据一致性风险，需谨慎处理

### 风险缓解

1. 生产上线前执行完整性能测试，根据结果微调配置
2. 缓存策略以只读数据为主，写入场景走数据库

## 日期

2026-01-31

## 相关文档

- ADR-003: 数据存储策略
- ADR-004: 服务间通信方式
- ADR-006: 异步处理策略
- technical-standards-v1.0: 性能规范
- infrastructure/kong/kong.yml: 网关配置
