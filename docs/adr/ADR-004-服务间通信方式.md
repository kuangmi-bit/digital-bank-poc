# ADR-004: 服务间通信方式

## 状态
已接受

## 上下文

数字银行 POC 采用微服务架构（ADR-002），核心银行、支付、风控、前端及 Kong、Consul 等组件需明确：服务间以何种协议与模式通信（同步/异步）、Kong 与 Consul 的职责，以及超时、重试、熔断等策略，以在 14 天交付约束下兼顾可实施性与可运维性。

## 考虑的选项

### 选项 1：全部 REST over HTTP

- 服务间仅通过 HTTP/1.1 REST 调用，JSON Body
- Kong 做网关与路由，Consul 做服务发现与配置
- 无 gRPC、无专用消息中间件（或仅用 HTTP Webhook 模拟异步）

### 选项 2：REST + gRPC 混合

- 面向外部/前端的 API：REST，经 Kong 暴露
- 服务间高频、对延迟敏感的内部调用：gRPC
- 需维护两套契约与码生成

### 选项 3：全部 gRPC

- 内外均 gRPC；Kong 需 gRPC 代理能力，浏览器/前端需 gRPC-Web 或 BFF 转 REST
- 二进制、多语言支持好，但 POC 周期内改造与调试成本高

### 选项 4：REST + 消息队列（如 RabbitMQ/Kafka）

- 同步：REST；异步：消息队列
- 引入额外中间件，部署与运维复杂度上升，与当前 workplan 中「可选」定位一致

## 选项比较

| 评估维度         | 选项 1: 全 REST（推荐） | 选项 2: REST + gRPC | 选项 3: 全 gRPC | 选项 4: REST + MQ |
|------------------|-------------------------|---------------------|-----------------|-------------------|
| **14 天可行性**  | ⭐⭐⭐⭐⭐ 与现有栈一致    | ⭐⭐⭐ 需双协议开发   | ⭐⭐ 工作量大     | ⭐⭐⭐ 取决于 MQ 是否已就绪 |
| **Kong/Consul 适配** | ⭐⭐⭐⭐⭐ 原生支持 HTTP    | ⭐⭐⭐⭐ Kong 支持 gRPC | ⭐⭐⭐ 需 gRPC 路由 | ⭐⭐⭐⭐ 需 MQ 部署 |
| **前端/第三方**  | ⭐⭐⭐⭐⭐ 直接调用 REST   | ⭐⭐⭐⭐ 对外仍 REST   | ⭐⭐ 需 BFF/gRPC-Web | ⭐⭐⭐⭐ 同选项 1 |
| **服务间性能**   | ⭐⭐⭐⭐ 对 POC 足够      | ⭐⭐⭐⭐⭐ 更优         | ⭐⭐⭐⭐⭐ 更优     | ⭐⭐⭐ 异步解耦    |
| **调试与排错**   | ⭐⭐⭐⭐⭐ 工具多、日志清晰 | ⭐⭐⭐ 两套工具链     | ⭐⭐⭐ 二进制调试 | ⭐⭐⭐ 需看 MQ 与链路 |
| **与 ADR-002**   | ⭐⭐⭐⭐⭐ 已约定 HTTP/REST | ⭐⭐⭐⭐ 扩展 gRPC     | ⭐⭐ 与现有描述不一致 | ⭐⭐⭐ 异步为补充  |

## 决策

采用**选项 1：以 REST over HTTP 作为主要服务间通信方式**，Kong 为统一 HTTP 网关，Consul 为服务发现与配置中心；异步场景在 POC 内优先通过 **HTTP 回调 / Webhook** 实现，消息队列作为可选增强，不纳入 Day 2 必选。

### 协议与格式

- **协议**：HTTP/1.1 或 HTTP/2（由基础设施支持情况决定），TLS 在生产/预发启用。
- **数据格式**：JSON；`Content-Type: application/json`；字符编码 UTF-8；日期时间 ISO 8601。

### Kong 的职责

- 统一入口：所有对外 API 经 Kong 暴露，路径前缀例如 `/api/v1/`。
- 路由：按 path/host 将请求转发到核心银行、支付、风控等上游服务。
- 认证：JWT 验证（按 `technical-standards` 安全规范）；可插件扩展。
- 限流、超时、熔断：在 Kong 或上游配置；限流与 `technical-standards` 性能规范一致（如全局限流、按服务/按用户）。
- 不替代业务逻辑；不长期存储业务数据。

### Consul 的职责

- **服务发现**：各服务注册自身实例（如 host:port、health path），消费者通过服务名解析。
- **健康检查**：对注册实例做 HTTP/ TCP 检查，故障实例从发现结果中剔除。
- **配置**：可选将非敏感配置放入 Consul KV，服务启动或定时间隔拉取。
- 不与 Kong 角色重叠；Kong 可通过 Consul 解析上游，也可使用静态 upstream。

### 同步调用约定

- **超时**：服务间调用建议 10s（与 `technical-standards` 一致）；对核心银行、支付、风控的入站请求，P95 &lt; 2s 为目标。
- **重试**：幂等操作可重试；重试次数与退避策略与 `technical-standards`、ADR-002 一致（如最多 3 次、指数退避）。
- **熔断**：在 Kong 或客户端配置；触发条件可参考「50% 错误率」等，避免故障扩散。
- **传播**：`traceId`、`spanId` 等通过 HTTP Header 透传，便于日志与排错（与 `technical-standards` 日志规范一致）。

### 异步与回调

- **场景**：支付结果通知、清算完成回调、部分风控告警等。
- **POC 默认方式**：调用方提供 HTTP 回调 URL，服务在事件发生后向该 URL 发送 POST，Body 为约定 JSON；至少一次投递，消费方需幂等。
- **消息队列**：若在 Day 5 或之后引入（见 ADR-006 规划），则 Topic/Queue 命名、消息格式、重试与死信遵循 `technical-standards` 的「消息队列规范」。

### 服务依赖与调用方向

- 与 ADR-002、`agent-dependency-matrix` 一致：  
  - 核心银行 ← 支付（扣款/冲正）、风控（事前风控校验，若采用）；  
  - 支付 ← 核心银行（扣款/余额）、风控（风控校验）；  
  - 风控 ← 仅被调用，不主动调核心银行/支付做业务写操作；  
  - 前端 → 经 Kong → 各后端；禁止循环依赖。

## 后果

### 正面影响

1. 与 ADR-001、ADR-002、`technical-standards` 及现有 Kong/Consul 设计一致，无需推翻已有约定。
2. 全 REST 降低协议种类，便于 OpenAPI 驱动开发、Postman/Cypress 测试与排错。
3. Kong、Consul 职责清晰：Kong = 流量与策略，Consul = 发现与配置。
4. 异步以 HTTP 回调为主，可在不引入 MQ 的前提下完成 POC 核心流程；为后续 MQ 留出接口与语义空间。

### 负面影响

1. 纯 REST 在极高 QPS、大 Body、流式场景下不如 gRPC 高效；对当前 POC 目标（如 100 TPS、P95 &lt; 2s）可接受。
2. 异步可靠性依赖回调端可用性与幂等设计；MQ 引入后可缓解。

### 风险缓解

1. 所有服务间接口在 OpenAPI 与 `api-design-spec-v1.0` 中明确契约，Agent 0 在后续决策窗口按契约做审批。
2. 超时、重试、熔断在基础设施与客户端两侧同时配置，避免仅依赖一端。
3. 若 Day 5 后启用 MQ，由 ADR-006 细化异步策略，并与本 ADR 并行生效（REST 仍为同步主通道）。

## 日期

2026-01-26

## 相关文档

- 技术标准: `docs/architecture/technical-standards-v1.0.md`
- ADR-001: 技术栈选择
- ADR-002: 微服务拆分策略
- API 设计规范: `docs/architecture/api-design-spec-v1.0.md`
- 基础设施架构: `docs/architecture/agent-5-infrastructure-architecture.md`
