# ADR-003: 数据存储策略

## 状态
已接受

## 上下文

数字银行 POC 采用混合技术栈与粗粒度微服务（ADR-001、ADR-002），各服务需独立数据存储。需明确：各存储的职责边界、选型依据、与数据字典及迁移脚本的对应关系，并统一缓存、检索组件的使用策略，以支撑 14 天交付与后续扩展。

## 考虑的选项

### 选项 1：单一关系型数据库（PostgreSQL）

- 所有业务数据存入 PostgreSQL
- 支付、风控数据通过表/分区与核心银行数据共存
- 强一致性、单一运维栈

### 选项 2：按服务多库（PostgreSQL + MongoDB + Elasticsearch + Redis）

- **PostgreSQL**：核心银行（客户、账户、交易），强事务、审计
- **MongoDB**：支付、清算，高写入、文档形态、易演进
- **Elasticsearch**：风控日志、检索、规则结果，分析与搜索
- **Redis**：会话、热点、限流、临时状态，低延迟

### 选项 3：多库 + 统一分析库

- 在选项 2 基础上增加独立数仓/分析库
- 各业务库通过 ETL/CDC 同步到分析库

### 选项 4：全部 NoSQL（MongoDB 为主）

- 核心银行、支付、风控均使用 MongoDB
- 通过应用层保证事务语义

## 选项比较

| 评估维度         | 选项 1: 单一 PG | 选项 2: 多库（推荐） | 选项 3: 多库 + 分析库 | 选项 4: 全 NoSQL |
|------------------|-----------------|----------------------|------------------------|------------------|
| **14 天可行性**  | ⭐⭐⭐⭐ 可行      | ⭐⭐⭐⭐⭐ 已对齐现状   | ⭐⭐ 额外工作量大       | ⭐⭐ 核心银行不适合 |
| **事务与一致性** | ⭐⭐⭐⭐⭐ 最强     | ⭐⭐⭐⭐ 按库强一致     | ⭐⭐⭐⭐ 同选项 2        | ⭐⭐ 需应用补偿     |
| **支付/清算适配**| ⭐⭐ 表结构偏刚性 | ⭐⭐⭐⭐⭐ 文档型更合适 | ⭐⭐⭐⭐⭐ 同选项 2      | ⭐⭐⭐⭐ 合适       |
| **风控检索**     | ⭐⭐ 需自建索引   | ⭐⭐⭐⭐⭐ ES 专长      | ⭐⭐⭐⭐⭐ 同选项 2      | ⭐⭐⭐ 需自建      |
| **运维与备份**   | ⭐⭐⭐⭐⭐ 最简单   | ⭐⭐⭐ 多组件可接受    | ⭐⭐ 更复杂             | ⭐⭐⭐ 中等        |
| **与 ADR-001/002** | ⭐ 与混合栈冲突 | ⭐⭐⭐⭐⭐ 完全一致     | ⭐⭐⭐⭐ 一致            | ⭐⭐ 与 PG/ES 冲突 |

## 决策

采用**选项 2：按服务多库策略**，与数据字典 v1.0、`database/` 下现有设计保持一致。

### 各存储职责与边界

| 存储          | 库 / Schema | 用途                     | 主要负责服务   | 依据文档 / 脚本                          |
|---------------|-------------|--------------------------|----------------|------------------------------------------|
| **PostgreSQL**| `public`    | 客户、账户、交易         | 核心银行(Agent 1) | `data-dictionary-v1.0`、`V1__init_schema.sql` |
| **MongoDB**   | `payment_db`| 支付订单、清算批次       | 支付清算(Agent 2) | `data-dictionary-v1.0`、`payment.json`、`settlement.json` |
| **Elasticsearch** | 索引按需 | 风控事件、规则命中、检索 | 风控(Agent 3)  | `technical-standards`、ADR-001/002       |
| **Redis**     | 按 key 前缀 | 会话、热点、限流、锁     | 各服务 / Agent 9 | `technical-standards` 缓存规范、`cb:`, `pay:`, `risk:` |

### 与数据模型的映射

- **PostgreSQL**：表 `customers`、`bank_accounts`、`transactions`；snake_case，主键 `id`，外键 `{table}_id`，金额 `DECIMAL(19,2)`，时间 `TIMESTAMP WITH TIME ZONE`。迁移：`database/postgresql/migrations/`。
- **MongoDB**：集合 `payments`、`settlements`；字段 camelCase；`paymentId`、`orderId`、`status`、`createdAt` 等与数据字典一致。Schema：`database/mongodb/schemas/`。
- **Elasticsearch**：索引名 snake_case（如 `risk_events`），字段映射明确，用于风控日志与查询，不替代 MongoDB/PostgreSQL 的主业务存储。
- **Redis**：Key 格式 `{service}:{module}:{entity}:{id}`，TTL 按数据类型（会话约 30 分钟、热点约 5 分钟等），不持久化核心业务主数据。

### 数据一致性原则

- **库内**：PostgreSQL、MongoDB 库内保持强一致性；Redis、Elasticsearch 按各自语义（缓存可过期、检索可最终一致）。
- **跨库/跨服务**：采用最终一致性；跨服务业务流程使用 Saga 或补偿；支付与核心银行之间通过明确接口与对账机制保证可核对。

## 后果

### 正面影响

1. 与 ADR-001、ADR-002、数据字典及现有迁移/Schema 完全对齐，无需推翻重做。
2. 各存储发挥所长：PostgreSQL 强事务、MongoDB 高并发文档、Elasticsearch 检索、Redis 高性能缓存。
3. 服务与数据边界清晰，便于 Agent 1/2/3/9 并行与交接。
4. 为后续分析库（选项 3）留出扩展空间，不影响当前 POC 范围。

### 负面影响

1. 需同时维护 PostgreSQL、MongoDB、Elasticsearch、Redis 的部署、备份与监控。
2. 跨库数据一致需在应用层显式设计（Saga、对账、补偿）。

### 风险缓解

1. 严格遵循 `data-dictionary-v1.0` 与 `technical-standards-v1.0` 的数据库与缓存规范。
2. 备份与恢复按 `technical-standards` 的「备份和恢复规范」执行；Redis、Elasticsearch 按需制定策略。
3. Agent 9 负责数据模型与迁移的总体一致性；Agent 0 在 Day 2 已对数据模型设计做审查并通过。

## 日期

2026-01-26

## 相关文档

- 数据字典: `docs/data-model/data-dictionary-v1.0.md`
- PostgreSQL 迁移: `database/postgresql/migrations/`
- MongoDB Schema: `database/mongodb/schemas/`
- 技术标准: `docs/architecture/technical-standards-v1.0.md`
- ADR-001: 技术栈选择
- ADR-002: 微服务拆分策略
