# ADR-006: 异步处理策略

## 状态

已接受

## 上下文

ADR-004 约定服务间以 REST 为主、异步以 HTTP 回调为主，并预留「若 Day 5 或之后引入 MQ 则由 ADR-006 细化」；technical-standards 已定义消息队列使用场景、Topic/Queue 命名、消息格式与处理规范。Day 4 支付服务已实现 **Bull + Redis** 的 `payment-callback` 队列，用于支付网关回调处理后的异步后续任务。本 ADR 明确 POC 内**异步处理策略**：何时同步、何时异步，以及已采用的队列选型、契约与运维约束。

## 决策

### 1. 同步 vs 异步

| 场景 | 方式 | 说明 |
|------|------|------|
| 服务间业务调用（扣款、风控、转账、支付处理） | **同步** REST | 按 ADR-004、ADR-005：支付→核心银行 balance/debit、核心银行/支付→风控 check，均同步 HTTP，超时 10s，幂等可重试。 |
| 支付网关 → 支付服务 结果通知 | **HTTP 回调** | 网关对支付服务 `POST /api/v1/payments/callback` 等约定 URL，payload 含 paymentId、status、gatewayOrderId 等；支付服务更新 Payment、可选入队 Bull 做后续处理。 |
| 支付回调后的后续处理（通知商户、日志、风控归档等） | **异步队列** | 支付服务 `callback-service` 在 `handleCallback` 内调用 `addCallbackJob`，将 `{ paymentId, callbackData }` 入队 Bull `payment-callback`；Redis 未配置时 no-op，不阻塞主流程。 |

### 2. 消息队列选型与使用

- **选型**：**Bull + Redis**。Redis 为 Bull 后端；与 ADR-003、cloud-resources 一致。
- **已实现**：`payment-service` 的 `payment-callback-queue`（`queues/payment-callback-queue.js`）。
  - **Queue 名**：`payment-callback`（与 technical-standards 的 `{service}.{event-type}` 对应为 `payment.callback` 的简化实现）。
  - **Job 类型**：`callback`；payload `{ paymentId, callbackData }`。
  - **默认选项**：`attempts: 3`，`backoff: { type: 'exponential', delay: 1000 }`，`removeOnComplete: 100`，`removeOnFail: 50`。
  - **无 Redis**：`REDIS_URI` 未配置时 `getQueue` 返回 null，`addCallbackJob`、`startProcessor` 为 no-op，服务可正常启动。

### 3. 与 technical-standards 的对应

- **重试**：最多 3 次、指数退避，与「消息处理规范」一致。
- **幂等**：消费者处理 `callback` job 时须幂等（如按 paymentId 去重）；当前 processor 仅打日志，后续扩展通知等逻辑时保持幂等。
- **死信**：Bull 默认 failed job 保留于 Redis；`removeOnFail: 50` 限制数量。若需正式死信队列，可新增 `payment-callback-dlq` 或等 Day 8+ 统一规范。
- **Topic/Queue 命名**：当前单 queue `payment-callback`；若新增队列，按 `{service}.{event-type}.{version}` 命名（如 `payment.transaction-completed.v1`）。

### 4. 其他异步场景（POC 内）

- **核心银行 → 通知**：ADR-004、Day 5 workplan 中「消息通知」为可选；若实现，可沿用 HTTP 回调或后续扩展 Bull/其他 MQ，由 ADR-006 增补。
- **风控告警、日志收集**：当前以同步调用与 ES 写入为主；若引入异步事件，须经 Agent 0 审批并更新本 ADR。

### 5. 运维与部署

- **Redis**：Bull 依赖 Redis；部署 payment-service 且启用回调队列时，须配置 `REDIS_URI`。无 Redis 时队列不启用，不影响同步支付流程与 HTTP 回调接收。
- **监控**：建议对 `payment-callback` 队列监控 job 堆积、失败率、处理延迟；与 Day 5 Agent 8 的 QA 监控、告警联动。

## 后果

### 正面影响

1. 同步主路径与 ADR-004、ADR-005 一致，异步边界清晰：仅支付回调后续处理走 Bull。
2. Bull + Redis 已在 Day 4 落地，本 ADR 将其标准化，避免各 Agent 自行引入不一致的 MQ 用法。
3. 无 Redis 时 no-op，便于本地开发与 CI。

### 负面影响

1. 引入 Redis 依赖；需部署与运维保障。
2. 死信与重试可观测性依赖 Bull/Redis 及后续监控配置。

### 风险缓解

1. 生产/QA 部署支付服务时显式配置 Redis；文档与 runbook 中注明。
2. Day 5+ 监控与告警覆盖队列深度与失败 job，便于排障。

## 日期

2026-01-26

## 相关文档

- ADR-004: 服务间通信方式  
- ADR-005: 服务间通信协议  
- technical-standards-v1.0: 消息队列规范  
- payment-service: `src/queues/payment-callback-queue.js`、`src/services/callback-service.js`
