# ADR-008: 批量与预约转账策略

## 状态

已接受

## 上下文

阶段 3（Day 8-10）需要扩展核心银行服务，支持批量转账和预约转账功能。这两个功能涉及：

1. **批量转账**: 一次请求处理多笔转账，需考虑事务边界、部分失败处理、性能优化
2. **预约转账**: 指定未来时间执行转账，需考虑任务调度、状态管理、取消机制

本 ADR 定义这两个功能的实现策略。

## 决策

### 1. 批量转账策略

#### 1.1 API 设计

```
POST /api/v1/transactions/batch-transfer
```

**请求体**:
```json
{
  "batchId": "batch-uuid",           // 客户端生成，用于幂等
  "transfers": [
    {
      "fromAccountId": 1,
      "toAccountId": 2,
      "amount": 100.00,
      "remark": "批量转账1"
    },
    // 最多 100 笔
  ]
}
```

**响应体**:
```json
{
  "code": 200,
  "data": {
    "batchId": "batch-uuid",
    "totalCount": 10,
    "successCount": 8,
    "failedCount": 2,
    "results": [
      {"index": 0, "transactionId": "TX001", "status": "completed"},
      {"index": 1, "transactionId": null, "status": "failed", "errorCode": "CBB002", "message": "余额不足"}
    ]
  }
}
```

#### 1.2 事务策略

| 策略 | 选择 | 说明 |
|------|------|------|
| **事务边界** | 单笔独立事务 | 避免单笔失败回滚全部 |
| **部分失败** | 允许 | 返回每笔结果，客户端处理 |
| **幂等控制** | batchId | 整批幂等，重复请求返回原结果 |
| **风控调用** | 每笔单独 | 独立风控检查 |

#### 1.3 性能优化

- **并行处理**: 使用 `CompletableFuture` 并行执行（最多 10 并发）
- **批量查询**: 预加载所有涉及账户
- **限制**: 单批最多 100 笔，单日最多 10 批

### 2. 预约转账策略

#### 2.1 API 设计

**创建预约**:
```
POST /api/v1/transactions/scheduled-transfer
```

```json
{
  "fromAccountId": 1,
  "toAccountId": 2,
  "amount": 100.00,
  "scheduledTime": "2026-02-01T10:00:00Z",
  "remark": "预约转账"
}
```

**查询预约**:
```
GET /api/v1/transactions/scheduled?accountId=1&status=pending
```

**取消预约**:
```
DELETE /api/v1/transactions/scheduled/{scheduledId}
```

#### 2.2 状态机

```
[pending] --到期执行--> [processing] --成功--> [completed]
    |                       |
    +---取消--> [cancelled]  +---失败--> [failed]
```

#### 2.3 调度策略

| 组件 | 选择 | 说明 |
|------|------|------|
| **调度器** | Spring @Scheduled | 每分钟扫描到期任务 |
| **执行窗口** | ±1 分钟 | scheduledTime 前后 1 分钟内执行 |
| **重试** | 3 次 | 失败后重试，间隔 1/5/10 分钟 |
| **锁机制** | 数据库行锁 | 防止重复执行 |

#### 2.4 数据模型

```sql
CREATE TABLE scheduled_transfers (
    id BIGSERIAL PRIMARY KEY,
    scheduled_id VARCHAR(36) UNIQUE NOT NULL,
    from_account_id BIGINT NOT NULL,
    to_account_id BIGINT NOT NULL,
    amount DECIMAL(19, 2) NOT NULL,
    scheduled_time TIMESTAMP WITH TIME ZONE NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    transaction_id VARCHAR(36),  -- 执行后关联
    retry_count INT DEFAULT 0,
    error_message TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_scheduled_from_account FOREIGN KEY (from_account_id) REFERENCES bank_accounts(id),
    CONSTRAINT fk_scheduled_to_account FOREIGN KEY (to_account_id) REFERENCES bank_accounts(id)
);

CREATE INDEX idx_scheduled_transfers_time_status ON scheduled_transfers(scheduled_time, status);
```

### 3. 账单支付策略（Agent 2 扩展）

#### 3.1 API 设计

```
POST /api/v1/payments/bill
```

```json
{
  "billType": "utility",           // utility/telecom/credit_card
  "billAccount": "1234567890",     // 账单账户号
  "amount": 150.00,
  "payerAccountId": 1
}
```

#### 3.2 处理流程

1. 验证账单信息（Mock 账单系统）
2. 调用核心银行扣款
3. 记录支付
4. 返回支付凭证

### 4. 错误码扩展

| 错误码 | HTTP | 描述 |
|--------|------|------|
| CBB010 | 400 | 批量转账超过限制 |
| CBB011 | 400 | 预约时间无效 |
| CBB012 | 404 | 预约不存在 |
| CBB013 | 400 | 预约已执行/取消 |
| PYB010 | 400 | 账单类型不支持 |
| PYB011 | 400 | 账单账户无效 |

## 后果

### 正面影响

1. 批量转账支持部分成功，提高业务灵活性
2. 预约转账支持取消，用户体验好
3. 账单支付扩展支付场景

### 负面影响

1. 预约转账需要定时任务调度，增加运维复杂度
2. 批量转账并行执行，需注意资源控制

### 风险缓解

1. 定时任务配置健康检查和告警
2. 批量转账限制并发数和批次大小
3. 预约转账执行失败后重试，最终状态通知用户

## 日期

2026-01-31

## 相关文档

- ADR-005: 服务间通信协议
- ADR-007: 性能优化策略
- technical-standards-v2.0: 错误码规范
