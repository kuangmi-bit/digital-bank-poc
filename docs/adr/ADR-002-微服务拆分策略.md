# ADR-002: 微服务拆分策略

## 状态
已接受

## 上下文

数字银行POC系统需要采用微服务架构，以满足以下需求：
- 独立开发和部署：不同服务可以独立开发和部署
- 技术栈多样性：不同服务可以使用最适合的技术栈
- 可扩展性：服务可以独立扩展
- 故障隔离：单个服务故障不影响整个系统
- AI Agent分工：每个Agent负责一个或多个服务

## 考虑的选项

### 选项1: 单体架构（Monolith）
- 所有功能在一个应用中
- 单一数据库
- 统一技术栈

### 选项2: 粗粒度微服务（3-4个服务）
- 核心银行服务（账户+交易）
- 支付服务
- 风控服务
- 前端应用

### 选项3: 细粒度微服务（按功能拆分）
- 账户服务
- 交易服务
- 客户服务
- 支付服务
- 清算服务
- 风控服务
- 限额服务
- 黑名单服务
- 前端应用

### 选项4: 领域驱动设计（DDD）拆分
- 按业务领域拆分
- 每个领域独立数据存储
- 领域间通过API通信

## 选项比较

| 评估维度 | 选项1: 单体架构 | 选项2: 粗粒度微服务 | 选项3: 细粒度微服务 | 选项4: DDD拆分 |
|---------|----------------|-------------------|-------------------|---------------|
| **开发速度** | ⭐⭐⭐⭐⭐ 最快 | ⭐⭐⭐⭐ 较快 | ⭐⭐ 较慢 | ⭐⭐⭐ 中等 |
| **技术栈灵活性** | ⭐ 单一技术栈 | ⭐⭐⭐⭐ 可不同技术栈 | ⭐⭐⭐⭐⭐ 完全灵活 | ⭐⭐⭐⭐ 可不同技术栈 |
| **独立部署** | ⭐ 无法独立部署 | ⭐⭐⭐⭐ 可独立部署 | ⭐⭐⭐⭐⭐ 完全独立 | ⭐⭐⭐⭐ 可独立部署 |
| **可扩展性** | ⭐⭐ 整体扩展 | ⭐⭐⭐⭐ 服务级扩展 | ⭐⭐⭐⭐⭐ 细粒度扩展 | ⭐⭐⭐⭐ 领域级扩展 |
| **故障隔离** | ⭐ 故障影响全部 | ⭐⭐⭐⭐ 故障隔离较好 | ⭐⭐⭐⭐⭐ 故障隔离最好 | ⭐⭐⭐⭐ 故障隔离较好 |
| **运维复杂度** | ⭐⭐⭐⭐⭐ 最简单 | ⭐⭐⭐ 中等 | ⭐⭐ 复杂 | ⭐⭐⭐ 中等 |
| **14天交付可行性** | ⭐⭐⭐⭐⭐ 最可行 | ⭐⭐⭐⭐ 可行 | ⭐⭐ 不可行 | ⭐⭐⭐ 较可行 |
| **AI Agent分工** | ⭐⭐ 难以分工 | ⭐⭐⭐⭐ 分工清晰 | ⭐⭐⭐⭐⭐ 分工最细 | ⭐⭐⭐⭐ 分工清晰 |

### 详细分析

#### 选项1: 单体架构
**优点**:
- 开发速度最快
- 运维最简单
- 事务处理简单（ACID保证）
- 14天交付最可行

**缺点**:
- 无法使用不同技术栈
- 无法独立扩展
- 故障影响整个系统
- 不符合微服务架构要求
- AI Agent难以分工协作

**结论**: 不符合项目要求（需要微服务架构）

#### 选项2: 粗粒度微服务（推荐）
**优点**:
- 开发速度较快，14天交付可行
- 可以针对不同服务使用不同技术栈
- 服务可以独立部署和扩展
- 故障隔离较好
- AI Agent分工清晰（每个Agent负责一个服务）
- 运维复杂度适中

**缺点**:
- 服务粒度较粗，未来拆分需要重构
- 某些服务可能承担多个职责

**适用场景**: 
- 14天快速交付
- 服务边界清晰
- 每个服务职责明确

#### 选项3: 细粒度微服务
**优点**:
- 服务职责最单一
- 故障隔离最好
- 可扩展性最强
- AI Agent分工最细

**缺点**:
- 开发速度慢，14天无法完成
- 运维复杂度高
- 服务间调用复杂
- 分布式事务处理复杂
- 过度设计，不符合POC项目需求

**结论**: 不适合14天快速交付的POC项目

#### 选项4: DDD拆分
**优点**:
- 按业务领域拆分，边界清晰
- 领域独立，数据独立
- 符合领域驱动设计原则

**缺点**:
- 需要深入的领域分析，时间成本高
- 14天交付时间紧张
- 可能过度设计

**结论**: 适合长期项目，不适合14天POC

## 决策

经过架构设计讨论，我们决定采用**选项2: 粗粒度微服务拆分策略**。

**选择理由**:
1. **14天交付可行性**: 粗粒度拆分可以在14天内完成开发和集成，细粒度拆分时间不足
2. **服务边界清晰**: 按业务领域拆分（核心银行、支付、风控），边界清晰，职责明确
3. **AI Agent分工**: 每个Agent负责一个服务，分工清晰，协作简单
4. **技术栈灵活**: 每个服务可以使用最适合的技术栈
5. **运维复杂度适中**: 服务数量适中，运维复杂度可控
6. **未来可扩展**: 如果未来需要，可以进一步拆分为细粒度服务

具体拆分策略如下：

### 服务拆分原则

1. **业务领域驱动**: 按照业务领域拆分服务
2. **数据独立性**: 每个服务拥有独立的数据存储
3. **API优先**: 服务间通过RESTful API通信
4. **单一职责**: 每个服务只负责一个业务领域
5. **高内聚低耦合**: 服务内部高内聚，服务间低耦合

### 核心服务拆分

#### 1. 核心银行服务 (Core Bank Service)
- **Agent**: Agent 1
- **技术栈**: Java 17 + Spring Boot 3.x + PostgreSQL 15
- **职责**:
  - 账户管理（开户、查询、余额管理）
  - 交易处理（行内转账、交易查询）
  - 客户信息管理（基础CRM功能）
- **数据存储**: PostgreSQL
- **API数量**: 15-20个

#### 2. 支付清算服务 (Payment Service)
- **Agent**: Agent 2
- **技术栈**: Node.js 20 + Express + MongoDB 7.0
- **职责**:
  - 支付网关接口（Mock接口优先）
  - 清算引擎（简化对账逻辑）
  - 交易回调处理（异步处理机制）
- **数据存储**: MongoDB
- **API数量**: 10-15个

#### 3. 风控合规服务 (Risk Service)
- **Agent**: Agent 3
- **技术栈**: Python 3.11 + FastAPI + Elasticsearch 8.x
- **职责**:
  - 交易限额检查
  - 基础风控规则引擎
  - 黑名单管理
- **数据存储**: Elasticsearch
- **API数量**: 8-10个

#### 4. 前端应用 (Frontend)
- **Agent**: Agent 4
- **技术栈**: React 18 + TypeScript 5.x + Tailwind CSS 3.x
- **职责**:
  - 用户界面展示
  - 用户交互处理
  - API调用封装
- **页面数量**: 5-8个

### 基础设施服务

#### 5. API网关 (API Gateway)
- **Agent**: Agent 5
- **技术栈**: Kong
- **职责**:
  - 统一API入口
  - 路由转发
  - 限流和熔断
  - 认证和授权

#### 6. 服务注册中心 (Service Registry)
- **Agent**: Agent 5
- **技术栈**: Consul
- **职责**:
  - 服务注册与发现
  - 健康检查
  - 配置管理

### 服务间通信

#### 同步通信
- **协议**: HTTP/REST
- **格式**: JSON
- **超时**: 2秒
- **重试**: 最多3次，指数退避

#### 异步通信
- **协议**: HTTP Webhook / 消息队列（可选）
- **场景**: 支付回调、异步通知

### 数据一致性策略

1. **最终一致性**: 服务间数据采用最终一致性
2. **分布式事务**: 使用Saga模式处理跨服务事务
3. **补偿机制**: 失败时执行补偿操作

### 服务边界

```
┌─────────────────────────────────────────────────┐
│              API Gateway (Kong)                  │
└─────────────────────────────────────────────────┘
           │         │         │         │
    ┌──────┴──┐ ┌────┴───┐ ┌───┴────┐ ┌──┴────┐
    │  Core   │ │Payment │ │  Risk  │ │Frontend│
    │  Bank   │ │Service │ │Service │ │        │
    │ Service │ │        │ │        │ │        │
    └────┬────┘ └───┬────┘ └───┬────┘ └────────┘
         │          │          │
    ┌────┴────┐ ┌───┴────┐ ┌───┴────┐
    │PostgreSQL│ │MongoDB │ │Elastic │
    │          │ │        │ │search  │
    └──────────┘ └────────┘ └────────┘
```

## 后果

### 正面影响

1. **独立开发**: 每个服务可以独立开发和部署，提高开发效率
2. **技术栈灵活**: 不同服务可以使用最适合的技术栈
3. **可扩展性**: 服务可以独立扩展，满足不同性能需求
4. **故障隔离**: 单个服务故障不影响整个系统
5. **AI Agent分工**: 每个Agent负责一个服务，职责清晰

### 负面影响

1. **分布式复杂性**: 需要处理分布式系统的复杂性（网络延迟、故障等）
2. **数据一致性**: 跨服务数据一致性需要额外处理
3. **运维复杂度**: 需要管理多个服务的部署和监控
4. **测试复杂度**: 需要更多的集成测试和E2E测试

### 风险缓解

1. **API网关**: 使用Kong统一API入口，简化客户端调用
2. **服务注册**: 使用Consul实现服务发现，简化服务间调用
3. **监控告警**: 使用Prometheus和Grafana监控所有服务
4. **自动化测试**: 全面的自动化测试确保服务间集成正确
5. **文档完善**: 完善的API文档和服务文档

## 日期
2026-01-26

## 相关文档
- 项目计划: `digital_bank_poc_plan.md`
- 技术标准规范: `docs/architecture/technical-standards-v1.0.md`
- ADR-001: 技术栈选择
